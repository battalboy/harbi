# Harbi - Arbitrage Betting System (Arbing Software)

## Client Requirements

**This is a commissioned software project.** The client requires that all traditional betting sites included in the project operate at **full capacity**, meaning:

- **Maximum team coverage**: Each traditional betting site must have as many team names collected as possible
- **Balanced coverage**: Having 150 teams for one site while another site has 1,000+ teams is **not acceptable**
- **Quality standard**: All included sites must provide comparable and comprehensive team coverage to maximize arbitrage opportunities
- **Implementation priority**: If a site cannot provide adequate team coverage through available API methods, alternative approaches (browser automation, etc.) must be implemented to meet the client's requirements

**Current Coverage Status:**
- Oddswar: ~1,874 teams ‚úÖ (Master key - defines available opportunities)
- Stoiximan: ~3,521 teams ‚úÖ (Excellent coverage - 88.8% match rate)
- Roobet: ~1,545 teams ‚úÖ (Good coverage - ~38% match rate)
- Tumbet: ~881 teams ‚ö†Ô∏è (Moderate coverage - ~49% match rate, API-based collection)

## Project Overview

**Project Name**: Harbi

This is **ARBING SOFTWARE**, not betting software. The goal is to identify and exploit odds discrepancies between:
- **Oddswar** (betting exchange - where you can "sell" or lay odds)
- **Stoiximan, Roobet & Tumbet** (traditional bookmakers - where you "buy" or back odds)

### How Arbitrage Works
1. Find the same event on both exchange and traditional bookmaker
2. Compare odds
3. When there's a profitable spread, "back" on the traditional site and "lay" on Oddswar
4. Profit from the difference with **minimal risk** (not speculative betting)

### Key Distinction
- **Traditional Bookmaker** (Stoiximan/Roobet/Stake/Tumbet): You bet FOR an outcome
- **Betting Exchange** (Oddswar): You can bet AGAINST an outcome (act as the bookmaker)
- **Arbitrage Opportunity**: When backing + laying the same outcome creates guaranteed profit

## Core Challenge: Two-Step Standardization

### Key Definitions
- **Team Name**: A single team (e.g., "Manchester United", "Liverpool FC")
- **Event**: When two teams are playing or have an upcoming match (e.g., "Manchester United vs Liverpool")
- **Goal**: Match team names across sites ‚Üí Match events across sites ‚Üí Compare odds for arbitrage

### Step 1: Standardize Team Names
The same team has different names across bookmakers.
- Example: "Man United" vs "Manchester United FC" vs "Manchester Utd"
- **Current focus**: Building team name mappings (`stoiximan_matches.csv`, `roobet_matches.csv`, `tumbet_matches.csv`)
- **Tools**: Fuzzy matching with special rules (indicators, diacritics)
- **Purpose**: Enable accurate event matching in Step 2

#### Matching Algorithm Details
The matching system uses **indicator-first filtering** to ensure accurate matches:

**Indicators Extracted:**
- **Age groups**: U19, U20, U21, U23 (youth teams)
- **Gender**: (W) (women's teams)
- **Reserve teams**: II or B (treated as equivalent under 'RESERVE' indicator)

**Matching Rules:**
- Teams are filtered by indicators BEFORE fuzzy matching
- Only teams with EXACT matching indicators can be compared
- Examples:
  - ‚úÖ Arsenal U19 ‚Üí can ONLY match teams with U19
  - ‚úÖ Arsenal (W) ‚Üí can ONLY match teams with (W)
  - ‚úÖ Arsenal ‚Üí can ONLY match teams WITHOUT indicators
  - ‚ùå Arsenal U19 ‚Üí CANNOT match Arsenal (no U19)
  - ‚ùå Arsenal (W) ‚Üí CANNOT match Arsenal FC (no W)
  - ‚ùå Juventus U20 ‚Üí CANNOT match Juventus U23 (different ages)

**Normalization Process:**
- **Diacritics removal**: √úmraniyespor ‚Üí Umraniyespor, Be≈üikta≈ü ‚Üí Besiktas
- **Case-insensitive**: NEOM Sports Club ‚Üí neom sports club (for comparison only)
- **Original names preserved**: Output CSVs contain original team names with proper casing

**Fuzzy Matching:**
- Uses `rapidfuzz` library with `fuzz.ratio` scorer
- **Current threshold**: 60% minimum similarity required for a match
- Lower threshold allows catching abbreviations (e.g., "Sports Club" vs "SC" at 60.9%)
- Accepts risk of false positives requiring manual review

#### Team Collection Scripts
- **Oddswar**: `collect_oddswar_teams.py` ‚Üí outputs `oddswar_names.txt`
- **Stoiximan**: `collect_stoiximan_teams.py` ‚Üí outputs `stoiximan_names.txt`
- **Roobet**: `collect_roobet_teams.py` ‚Üí outputs `roobet_names.txt`
  - Uses Betby API (sptpub.com) with two-step version system
  - **Breakthrough discovery**: The `rest_events_versions` array in API manifest unlocks comprehensive coverage
  - **Critical**: Fetches from multiple `rest_events_versions` endpoints (each contains ~160 matches)
  - Changed collection from ~60 teams (main version only) to 700+ teams (all versions)
  - Can collect comprehensive coverage in single run (~10 seconds) vs waiting days/weeks
  - Fetches both LIVE and PREMATCH matches
  - No geographic restrictions
- **Tumbet**: `collect_tumbet_teams.py` ‚Üí outputs `tumbet_names.txt`
  - Uses SportWide API (analytics-sp.googleserv.tech)
  - Fetches both live and prematch data
  - No geographic restrictions on API (website requires Turkish VPN)

#### Team Matching Scripts
- **Stoiximan Matching**: `create_stoiximan_matches_csv.py` ‚Üí creates `stoiximan_matches.csv` (Oddswar ‚Üî Stoiximan mappings with confidence scores)
- **Roobet Matching**: `create_roobet_matches_csv.py` ‚Üí creates `roobet_matches.csv` (Oddswar ‚Üî Roobet mappings with confidence scores)
- **Tumbet Matching**: `create_tumbet_matches_csv.py` ‚Üí creates `tumbet_matches.csv` (Oddswar ‚Üî Tumbet mappings with confidence scores)

#### API Parser Scripts (in `old/` folder)
These scripts fetch live and upcoming matches with full details (teams, odds, links):
- `old/oddswar_api_complete_parser.py` ‚Üí `old/oddswar-formatted.txt` (live + upcoming matches)
- `old/stoiximan_api_complete_parser.py` ‚Üí `old/stoiximan-formatted.txt` (live only - no prematch API available)
- `old/roobet_api_complete_parser.py` ‚Üí `old/roobet-formatted.txt` (live + prematch via Betby API)
- `old/tumbet_api_complete_parser.py` ‚Üí `old/tumbet-formatted.txt` (live + prematch via SportWide API)

These can extract team names from formatted output and add them to `*_names.txt` files to discover new teams.

#### Workflow: Proper Team Name Matching Sequence
To perform a complete team name matching run, execute scripts in this order:
1. `collect_oddswar_teams.py` - Collect Oddswar teams (master key)
2. `collect_stoiximan_teams.py` - Collect Stoiximan teams
3. `collect_roobet_teams.py` - Collect Roobet teams
4. `collect_tumbet_teams.py` - Collect Tumbet teams
5. `create_stoiximan_matches_csv.py` - Match Oddswar ‚Üî Stoiximan
6. `create_roobet_matches_csv.py` - Match Oddswar ‚Üî Roobet
7. `create_tumbet_matches_csv.py` - Match Oddswar ‚Üî Tumbet

#### Future Traditional Sites
- **Stake.com** - To be added for expanded arbitrage opportunities

#### **IMPORTANT: Oddswar as Master Key**
- **Oddswar team names are the MASTER KEY** for all comparisons
- All matching is structured as: **Oddswar ‚Üî Traditional Site** (not the reverse)
- **If a team isn't on Oddswar, it won't appear in the software** - Oddswar defines the universe of possible arbitrage opportunities
- This is because:
  - Oddswar is the **exchange** (where you lay/sell odds)
  - Stoiximan/Roobet/Tumbet are **traditional bookmakers** (where you back/buy odds)
  - Arbitrage identification requires: "Is this Oddswar event also on traditional sites?"
  - Teams/events that only exist on traditional sites (but not Oddswar) are irrelevant for arbitrage
- CSV structure: `Oddswar` column is always first, followed by the traditional site column
- Unmatched traditional site teams (no Oddswar equivalent) are not used

### Step 2: Standardize Event Formats
Events (two teams playing each other) are formatted differently across sites.
- Example formats:
  - "Manchester United vs Liverpool"
  - "Liverpool v Man Utd"
  - "Man United - Liverpool FC"
- **Requirement**: Must identify that these represent the SAME event
- **Dependencies**: Requires Step 1 (team name matching) to be completed first
- **Critical**: Only after BOTH standardizations work can we compare odds

### Why Both Matter
- ‚ùå **Wrong team match** = Comparing different teams = False arbitrage
- ‚ùå **Wrong event format** = Missing valid opportunities or wrong pairings
- ‚úÖ **Both correct** = Valid arbitrage opportunity identification

### Current Status
- ‚úÖ **Step 1 Complete**: Team name matching working (88.8% Stoiximan, ~38% Roobet, ~49% Tumbet)
- üîú **Step 2 Next**: Event matching across sites (not yet implemented)

## Important
This system does NOT place bets automatically. It identifies opportunities for the user to manually execute.

## Development Workflow Rules
- **Git Commits & Pushes**: DO NOT commit to local git or push to GitHub unless the user explicitly requests it
- Only perform git operations (add, commit, push) when the user gives express permission
- **Documentation**: DO NOT create large markdown documentation files for small code fixes, bug fixes, or routine changes. Report changes concisely in the chat instead. Reserve documentation files for significant features, architectural decisions, or complex system explanations only.
